<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شركة نايف للأغذية - نظام مراقبة الأسعار</title>
    <link rel="icon" href="https://i.postimg.cc/NM2zJWZD/NAIF-LOGO.jpg" type="image/jpeg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-green: #00FF9D;
            --primary-orange: #FF6E00;
            --light-blue: #4A90E2;
            --light-bg: #E8F4FF;
            --card-bg: #FFFFFF;
            --text-color: #333333;
            --border-color: #DDDDDD;
            --header-blue: #2C6FB7;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            min-height: 100vh;
            direction: rtl;
            background-image: linear-gradient(to bottom right, #E8F4FF, #D1E9FF);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--header-blue), var(--light-blue));
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 20px rgba(44, 111, 183, 0.2);
            color: white;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid white;
        }
        
        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .company-name {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header-info {
            text-align: left;
        }
        
        .date-display {
            font-size: 1.2rem;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .system-title {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* Navigation */
        nav {
            background-color: white;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .nav-tabs {
            display: flex;
            list-style: none;
            flex-wrap: wrap;
        }
        
        .nav-tabs li {
            flex: 1;
            min-width: 150px;
        }
        
        .nav-tabs li a {
            display: block;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tabs li a:hover, .nav-tabs li a.active {
            background-color: rgba(74, 144, 226, 0.1);
            color: var(--light-blue);
            border-bottom: 3px solid var(--primary-green);
        }
        
        /* Main Content */
        .main-content {
            display: none;
        }
        
        .main-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page-title {
            font-size: 1.8rem;
            color: var(--header-blue);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-green);
        }
        
        /* Cards & Forms */
        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 1.4rem;
            color: var(--light-blue);
        }
        
        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary-orange), var(--light-blue));
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 110, 0, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #888, #AAA);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: var(--light-blue);
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 15px;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-color);
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 110, 0, 0.1);
        }
        
        /* Search Suggestions */
        .suggestions-container {
            position: relative;
        }
        
        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .suggestions-list.active {
            display: block;
        }
        
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-item:hover {
            background-color: rgba(74, 144, 226, 0.1);
        }
        
        /* Invoice Table */
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .invoice-table th, .invoice-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .invoice-table th {
            background-color: rgba(74, 144, 226, 0.1);
            color: var(--light-blue);
            font-weight: 600;
        }
        
        .invoice-table tr:hover {
            background-color: rgba(74, 144, 226, 0.05);
        }
        
        .price-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.85rem;
            text-align: right;
        }
        
        .price-info span {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        
        .last-price {
            background-color: rgba(0, 255, 157, 0.15);
            color: #006600;
        }
        
        .high-price {
            background-color: rgba(255, 0, 0, 0.1);
            color: #990000;
        }
        
        .low-price {
            background-color: rgba(0, 150, 255, 0.1);
            color: #004080;
        }
        
        /* Statistics Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, white, #F8FBFF);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            color: var(--primary-orange);
            margin-bottom: 15px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--light-blue);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #666;
        }
        
        /* Floating Cards */
        .floating-cards {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 999;
        }
        
        .floating-card {
            background: linear-gradient(135deg, var(--primary-orange), var(--light-blue));
            color: white;
            padding: 15px;
            border-radius: 10px;
            width: 180px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            animation: floatCard 6s ease-in-out infinite;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .floating-card:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes floatCard {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .floating-card:nth-child(2) {
            animation-delay: 1s;
        }
        
        .floating-card:nth-child(3) {
            animation-delay: 2s;
        }
        
        /* Report Tables */
        .report-table-container {
            overflow-x: auto;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .report-table th, .report-table td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .report-table th {
            background-color: rgba(74, 144, 226, 0.15);
            color: var(--light-blue);
            font-weight: 600;
        }
        
        .report-table tr:nth-child(even) {
            background-color: rgba(74, 144, 226, 0.03);
        }
        
        .report-table tr:hover {
            background-color: rgba(74, 144, 226, 0.08);
        }
        
        /* Invoice Details Table */
        .invoice-details-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .invoice-details-table th, .invoice-details-table td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .invoice-details-table th {
            background: linear-gradient(135deg, var(--light-blue), var(--header-blue));
            color: white;
            font-weight: 600;
        }
        
        .invoice-details-table tr:nth-child(even) {
            background-color: rgba(74, 144, 226, 0.05);
        }
        
        .invoice-details-table .total-row {
            background-color: rgba(255, 110, 0, 0.1);
            font-weight: bold;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .floating-cards {
                position: static;
                transform: none;
                flex-direction: row;
                justify-content: center;
                flex-wrap: wrap;
                margin-top: 30px;
            }
            
            .stats-container {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .company-name {
                font-size: 1.5rem;
            }
            
            .invoice-table th, .invoice-table td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
        }
        
        /* توقيع المطور */
        .signature-card {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #FF6E00, #2196F3);
            color: white;
            padding: 10.5px 17.5px;
            border-radius: 8.5px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            animation: float 6s ease-in-out infinite;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .signature-card:hover { 
            transform: scale(1.05); 
            box-shadow: 0 12px 35px rgba(0,0,0,0.3); 
        }

        @keyframes float { 
            0% { transform: translateY(0px); } 
            50% { transform: translateY(-15px); } 
            100% { transform: translateY(0px); } 
        }

        .signature-card::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(135deg, #80EF80, #2196F3);
            border-radius: 14px;
            z-index: -1;
            animation: borderGlow 3s linear infinite;
            background-size: 400%;
        }

        @keyframes borderGlow { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }

        .signature-card .name { 
            font-size: 0.95rem; 
            font-weight: 700; 
            margin-bottom: 5px; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); 
        }

        .signature-card .title { 
            font-size: 0.7rem; 
            opacity: 0.9; 
            font-weight: 500; 
        }

        @media (max-width: 768px) { 
            .signature-card { 
                position: relative; 
                bottom: auto; 
                left: auto; 
                margin: 20px auto 0; 
                width: fit-content; 
                animation: none; 
            } 
            .signature-card:hover { 
                transform: none; 
            } 
        }

        @media print {
            .signature-card, .floating-cards {
                display: none;
            }
            
            body {
                background-color: white !important;
            }
            
            .card {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }
        }
        
        /* Amount formatting */
        .amount {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        /* Invoice number badge */
        .invoice-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary-orange), var(--light-blue));
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px;
        }
        
        /* Warning messages */
        .warning-message {
            background-color: #FFF3CD;
            color: #856404;
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #FFEAA7;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Success messages */
        .success-message {
            background-color: #D4EDDA;
            color: #155724;
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #C3E6CB;
            margin-bottom: 15px;
        }
        
        /* Price Alert */
        .price-alert {
            background-color: #F8D7DA;
            color: #721C24;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #F5C6CB;
            margin-top: 5px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            70% { box-shadow: 0 0 0 5px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        
        .price-alert.high-price-alert {
            background-color: #F8D7DA;
            color: #721C24;
            border-color: #F5C6CB;
        }
        
        .price-alert.low-price-alert {
            background-color: #D1ECF1;
            color: #0C5460;
            border-color: #BEE5EB;
        }
        
        .price-alert.immediate-high-alert {
            background-color: #DC3545;
            color: white;
            border-color: #C82333;
            animation: immediatePulse 0.5s infinite;
            font-weight: bold;
        }
        
        @keyframes immediatePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        /* Price comparison indicator */
        .price-indicator {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .price-increase {
            background-color: #F8D7DA;
            color: #721C24;
        }
        
        .price-decrease {
            background-color: #D4EDDA;
            color: #155724;
        }
        
        .price-same {
            background-color: #FFF3CD;
            color: #856404;
        }
        
        /* Empty state placeholder */
        .empty-placeholder::placeholder {
            color: #999;
            font-style: italic;
        }
        
        /* Highlight for high price input */
        .high-price-input {
            border-color: #DC3545 !important;
            background-color: #FFF5F5 !important;
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.1) !important;
        }
        
        .price-input-container {
            position: relative;
        }
        
        .price-input-alert {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #DC3545;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 10;
            animation: bounce 0.5s infinite alternate;
        }
        
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-3px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="logo-container">
                <div class="logo">
                    <img src="https://i.postimg.cc/NM2zJWZD/NAIF-LOGO.jpg" alt="شركة نايف للأغذية">
                </div>
                <div class="company-name">شركة نايف للأغذية</div>
            </div>
            <div class="header-info">
                <div class="date-display" id="currentDate"></div>
                <div class="system-title">نظام مراقبة أسعار الشراء - 2025</div>
            </div>
        </header>
        
        <!-- Navigation -->
        <nav>
            <ul class="nav-tabs">
                <li><a href="#" class="nav-link active" data-target="dashboard">لوحة التحكم</a></li>
                <li><a href="#" class="nav-link" data-target="purchase-invoice">فاتورة شراء</a></li>
                <li><a href="#" class="nav-link" data-target="suppliers">الموردين</a></li>
                <li><a href="#" class="nav-link" data-target="products">الأصناف</a></li>
                <li><a href="#" class="nav-link" data-target="reports">التقارير</a></li>
            </ul>
        </nav>
        
        <!-- Dashboard -->
        <section id="dashboard" class="main-content active">
            <h2 class="page-title">لوحة التحكم</h2>
            
            <!-- Statistics Cards -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-value" id="suppliersCount">0</div>
                    <div class="stat-label">عدد الموردين</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-boxes"></i></div>
                    <div class="stat-value" id="productsCount">0</div>
                    <div class="stat-label">عدد الأصناف</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                    <div class="stat-value" id="invoicesCount">0</div>
                    <div class="stat-label">فواتير الشراء</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="stat-value" id="avgPriceChange">0%</div>
                    <div class="stat-label">متوسط تغير السعر</div>
                </div>
            </div>
            
            <!-- Recent Purchases -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">أحدث عمليات الشراء</h3>
                    <button class="btn btn-secondary" onclick="showPage('purchase-invoice')">إضافة فاتورة جديدة</button>
                </div>
                <div class="table-container">
                    <table class="invoice-table" id="recentPurchasesTable">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>المورد</th>
                                <th>التاريخ</th>
                                <th>عدد الأصناف</th>
                                <th>المجموع</th>
                            </tr>
                        </thead>
                        <tbody id="recentPurchasesBody">
                            <!-- سيتم ملؤها بواسطة JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Purchase Invoice -->
        <section id="purchase-invoice" class="main-content">
            <h2 class="page-title">فاتورة شراء جديدة</h2>
            
            <div class="card">
                <form id="purchaseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoiceNumber">رقم الفاتورة *</label>
                            <input type="text" id="invoiceNumber" placeholder="أدخل رقم الفاتورة كما في الفاتورة الأصلية" required>
                            <small style="color: #666; font-size: 0.9rem;">أدخل رقم الفاتورة كما في الفاتورة المطبوعة من المورد</small>
                        </div>
                        <div class="form-group">
                            <label for="invoiceDate">تاريخ الفاتورة</label>
                            <input type="date" id="invoiceDate" required>
                        </div>
                        <div class="form-group">
                            <label for="supplierSearch">بحث عن المورد</label>
                            <div class="suggestions-container">
                                <input type="text" id="supplierSearch" placeholder="اكتب اسم المورد للبحث" autocomplete="off">
                                <div class="suggestions-list" id="supplierSuggestions"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">أصناف الفاتورة</h3>
                            <button type="button" class="btn" id="addProductRow">إضافة صنف</button>
                        </div>
                        
                        <div class="table-container">
                            <table class="invoice-table" id="invoiceItemsTable">
                                <thead>
                                    <tr>
                                        <th>الصنف</th>
                                        <th>الوحدة</th>
                                        <th>الكمية</th>
                                        <th>سعر الشراء</th>
                                        <th>المجموع</th>
                                        <th>معلومات الأسعار السابقة</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceItemsBody">
                                    <!-- سيتم إضافة الأسطر هنا -->
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td colspan="4" style="text-align: left; font-weight: bold; font-size: 1.1rem;">الإجمالي:</td>
                                        <td id="invoiceTotal" style="font-weight: bold; font-size: 1.1rem;" class="amount">0.000</td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <button type="submit" class="btn" style="padding: 12px 30px;">حفظ الفاتورة</button>
                        <button type="button" class="btn btn-secondary" onclick="resetInvoiceForm()">إلغاء</button>
                    </div>
                </form>
            </div>
        </section>
        
        <!-- Suppliers -->
        <section id="suppliers" class="main-content">
            <h2 class="page-title">إدارة الموردين</h2>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">إضافة مورد جديد</h3>
                </div>
                <form id="supplierForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="supplierName">اسم المورد *</label>
                            <input type="text" id="supplierName" required>
                        </div>
                        <div class="form-group">
                            <label for="supplierPhone">رقم الهاتف</label>
                            <input type="text" id="supplierPhone">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="supplierEmail">البريد الإلكتروني</label>
                            <input type="email" id="supplierEmail">
                        </div>
                        <div class="form-group">
                            <label for="supplierAddress">العنوان</label>
                            <input type="text" id="supplierAddress">
                        </div>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn">حفظ المورد</button>
                        <button type="button" class="btn btn-secondary" onclick="resetSupplierForm()">إلغاء</button>
                    </div>
                </form>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">قائمة الموردين</h3>
                </div>
                <div class="table-container">
                    <table class="report-table" id="suppliersTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>اسم المورد</th>
                                <th>الهاتف</th>
                                <th>البريد الإلكتروني</th>
                                <th>العنوان</th>
                                <th>عدد الأصناف</th>
                                <th>إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="suppliersList">
                            <!-- سيتم ملؤها بواسطة JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Products -->
        <section id="products" class="main-content">
            <h2 class="page-title">إدارة الأصناف</h2>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">إضافة صنف جديد</h3>
                </div>
                <form id="productForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productName">اسم الصنف *</label>
                            <input type="text" id="productName" required>
                        </div>
                        <div class="form-group">
                            <label for="productSupplier">المورد *</label>
                            <select id="productSupplier" required>
                                <option value="">اختر المورد</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productUnit">وحدة القياس *</label>
                            <select id="productUnit" required>
                                <option value="">اختر الوحدة</option>
                                <option value="كيلو">كيلو</option>
                                <option value="علبة">علبة</option>
                                <option value="كارتون">كارتون</option>
                                <option value="طرد">طرد</option>
                                <option value="لتر">لتر</option>
                                <option value="جرام">جرام</option>
                                <option value="قطعة">قطعة</option>
                                <option value="متر">متر</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="productCategory">الفئة</label>
                            <input type="text" id="productCategory">
                        </div>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn">حفظ الصنف</button>
                        <button type="button" class="btn btn-secondary" onclick="resetProductForm()">إلغاء</button>
                    </div>
                </form>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">قائمة الأصناف</h3>
                </div>
                <div class="table-container">
                    <table class="report-table" id="productsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>اسم الصنف</th>
                                <th>المورد</th>
                                <th>الوحدة</th>
                                <th>الفئة</th>
                                <th>تاريخ آخر شراء</th>
                                <th>سعر آخر شراء</th>
                                <th>إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="productsList">
                            <!-- سيتم ملؤها بواسطة JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Reports -->
        <section id="reports" class="main-content">
            <h2 class="page-title">التقارير والإحصائيات - 2025</h2>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">تقارير الأسعار</h3>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="reportType">نوع التقرير</label>
                        <select id="reportType" onchange="changeReportType()">
                            <option value="productsReport">تقرير الأصناف</option>
                            <option value="suppliersReport">تقرير الموردين</option>
                            <option value="priceChanges">تغيرات الأسعار</option>
                            <option value="purchaseHistory">سجل المشتريات</option>
                            <option value="invoiceDetails">تفاصيل الفواتير</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportFilter">فلتر حسب</label>
                        <select id="reportFilter">
                            <option value="all">الكل</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportDate">التاريخ من</label>
                        <input type="date" id="reportDate">
                    </div>
                    <div class="form-group">
                        <label for="reportDateTo">إلى</label>
                        <input type="date" id="reportDateTo">
                    </div>
                </div>
                <div class="form-group">
                    <button class="btn" onclick="generateReport()">إنشاء التقرير</button>
                    <button class="btn btn-secondary" onclick="printReport()">طباعة التقرير</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" id="reportTitle">عرض التقرير</h3>
                </div>
                <div class="report-table-container" id="reportContainer">
                    <div id="reportContent">
                        <!-- سيتم عرض التقرير هنا -->
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Floating Statistics Cards -->
    <div class="floating-cards">
        <div class="floating-card">
            <div style="font-size: 1.2rem; font-weight: bold;">الموردين النشطين</div>
            <div style="font-size: 1.5rem; margin-top: 5px;" id="floatingActiveSuppliers">5</div>
        </div>
        <div class="floating-card">
            <div style="font-size: 1.2rem; font-weight: bold;">أعلى سعر زيادة</div>
            <div style="font-size: 1.5rem; margin-top: 5px;" id="floatingHighestIncrease">15%</div>
        </div>
        <div class="floating-card">
            <div style="font-size: 1.2rem; font-weight: bold;">آخر تحديث</div>
            <div style="font-size: 1rem; margin-top: 5px;" id="floatingLastUpdate">اليوم</div>
        </div>
    </div>
    
    <!-- Developer Signature -->
    <div class="signature-card">
        <div class="name">Yasser Elkhateeb</div>
        <div class="title">مطور البرنامج 67011143</div>
    </div>

    <script>
        // بيانات التطبيق
        let appData = {
            suppliers: [],
            products: [],
            invoices: [],
            currentInvoiceItems: [],
            editingSupplierId: null,
            editingProductId: null,
            nextSupplierId: 1,
            nextProductId: 1,
            nextInvoiceId: 1
        };
        
        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // تعيين التاريخ الحالي
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = today;
            document.getElementById('reportDate').value = today;
            document.getElementById('reportDateTo').value = today;
            
            // تحديث عرض التاريخ
            updateCurrentDate();
            
            // تهيئة البيانات المخزنة محلياً
            initializeData();
            
            // إعداد مستمعي الأحداث
            setupEventListeners();
            
            // إضافة 5 أسطر فارغة لفاتورة الشراء
            for(let i = 0; i < 5; i++) {
                addInvoiceRow();
            }
            
            // عرض لوحة التحكم أولاً
            showPage('dashboard');
            
            // تحديث الإحصائيات
            updateStatistics();
        });
        
        // تحديث التاريخ الحالي
        function updateCurrentDate() {
            const now = new Date();
            const day = now.getDate();
            const month = now.toLocaleString('ar-SA', { month: 'long' });
            const year = now.getFullYear();
            document.getElementById('currentDate').textContent = `${day} ${month} ${year}`;
        }
        
        // تهيئة البيانات من LocalStorage أو إنشاء بيانات تجريبية
        function initializeData() {
            const savedData = localStorage.getItem('purchaseTrackingData2025');
            
            if(savedData) {
                appData = JSON.parse(savedData);
            } else {
                // إنشاء بيانات تجريبية
                createSampleData();
            }
            
            // تحديث القوائم المنسدلة
            updateSupplierDropdown();
            populateSuppliersList();
            populateProductsList();
            updateRecentPurchases();
            updateReportFilters();
        }
        
        // إنشاء بيانات تجريبية
        function createSampleData() {
            // إضافة موردين تجريبيين
            appData.suppliers = [
                {id: 1, name: "مورد الخضروات الطازجة", phone: "123456789", email: "veg@example.com", address: "الكويت - حولي"},
                {id: 2, name: "مورد المواد الجافة", phone: "987654321", email: "dry@example.com", address: "الكويت - الشويخ"},
                {id: 3, name: "مورد المنتجات المجمدة", phone: "555555555", email: "frozen@example.com", address: "الكويت - السالمية"}
            ];
            appData.nextSupplierId = 4;
            
            // إضافة أصناف تجريبية
            appData.products = [
                {id: 1, name: "طماطم", supplierId: 1, unit: "كيلو", category: "خضروات"},
                {id: 2, name: "بصل", supplierId: 1, unit: "كيلو", category: "خضروات"},
                {id: 3, name: "أرز بسمتي", supplierId: 2, unit: "كيلو", category: "مواد جافة"},
                {id: 4, name: "سكر", supplierId: 2, unit: "كيلو", category: "مواد جافة"},
                {id: 5, name: "دجاج مجمد", supplierId: 3, unit: "كيلو", category: "مجمدات"}
            ];
            appData.nextProductId = 6;
            
            // إضافة فواتير تجريبية
            appData.invoices = [
                {
                    id: 1,
                    invoiceNumber: "INV-2025-001",
                    date: "2025-01-10",
                    supplierId: 1,
                    items: [
                        {productId: 1, productName: "طماطم", unit: "كيلو", quantity: 50, price: 0.750, total: 37.500},
                        {productId: 2, productName: "بصل", unit: "كيلو", quantity: 30, price: 0.350, total: 10.500}
                    ],
                    total: 48.000
                },
                {
                    id: 2,
                    invoiceNumber: "INV-2025-002",
                    date: "2025-01-15",
                    supplierId: 2,
                    items: [
                        {productId: 3, productName: "أرز بسمتي", unit: "كيلو", quantity: 100, price: 0.950, total: 95.000},
                        {productId: 4, productName: "سكر", unit: "كيلو", quantity: 50, price: 0.450, total: 22.500}
                    ],
                    total: 117.500
                }
            ];
            appData.nextInvoiceId = 3;
            
            // حفظ البيانات
            saveData();
        }
        
        // حفظ البيانات في LocalStorage
        function saveData() {
            localStorage.setItem('purchaseTrackingData2025', JSON.stringify(appData));
            updateStatistics();
        }
        
        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // التنقل بين الصفحات
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = this.getAttribute('data-target');
                    showPage(target);
                    
                    // تحديث حالة التنقل النشط
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // بحث الموردين - يظهر من أول حرف
            document.getElementById('supplierSearch').addEventListener('input', function() {
                searchSuppliers(this.value);
            });
            
            // إضافة صف جديد في الفاتورة
            document.getElementById('addProductRow').addEventListener('click', function() {
                addInvoiceRow();
            });
            
            // حفظ الفاتورة
            document.getElementById('purchaseForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveInvoice();
            });
            
            // حفظ المورد
            document.getElementById('supplierForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSupplier();
            });
            
            // حفظ الصنف
            document.getElementById('productForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveProduct();
            });
        }
        
        // عرض صفحة معينة
        function showPage(pageId) {
            // إخفاء جميع الصفحات
            document.querySelectorAll('.main-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // عرض الصفحة المطلوبة
            document.getElementById(pageId).classList.add('active');
            
            // تحديث الإحصائيات إذا كانت صفحة لوحة التحكم
            if(pageId === 'dashboard') {
                updateStatistics();
                updateRecentPurchases();
            }
            
            // تحديث القوائم إذا كانت صفحة الموردين أو الأصناف
            if(pageId === 'suppliers') {
                populateSuppliersList();
            }
            
            if(pageId === 'products') {
                populateProductsList();
                updateSupplierDropdown();
            }
        }
        
        // البحث عن موردين - يظهر من أول حرف
        function searchSuppliers(query) {
            const suggestionsList = document.getElementById('supplierSuggestions');
            
            if(query.trim().length === 0) {
                suggestionsList.classList.remove('active');
                return;
            }
            
            const filteredSuppliers = appData.suppliers.filter(supplier =>
                supplier.name.toLowerCase().includes(query.toLowerCase())
            );
            
            if(filteredSuppliers.length === 0) {
                suggestionsList.innerHTML = '<div class="suggestion-item">لا توجد نتائج</div>';
            } else {
                suggestionsList.innerHTML = filteredSuppliers.map(supplier =>
                    `<div class="suggestion-item" data-id="${supplier.id}" data-name="${supplier.name}">${supplier.name}</div>`
                ).join('');
                
                // إضافة مستمعي الأحداث لعناصر الاقتراحات
                suggestionsList.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', function() {
                        document.getElementById('supplierSearch').value = this.getAttribute('data-name');
                        suggestionsList.classList.remove('active');
                    });
                });
            }
            
            suggestionsList.classList.add('active');
        }
        
        // إضافة صف جديد في فاتورة الشراء
        function addInvoiceRow(productId = null) {
            const tbody = document.getElementById('invoiceItemsBody');
            const rowIndex = tbody.children.length;
            
            const row = document.createElement('tr');
            row.id = `invoiceRow-${rowIndex}`;
            
            // إنشاء خلية البحث عن الصنف
            const productCell = document.createElement('td');
            productCell.innerHTML = `
                <div class="suggestions-container">
                    <input type="text" class="product-search empty-placeholder" placeholder="ابحث عن الصنف" data-row="${rowIndex}" autocomplete="off">
                    <div class="suggestions-list product-suggestions" id="productSuggestions-${rowIndex}"></div>
                </div>
                <input type="hidden" class="product-id" id="productId-${rowIndex}">
            `;
            
            // إنشاء خلية السعر مع حاوية للتنبيه الفوري
            const priceCell = document.createElement('td');
            priceCell.className = 'price-input-container';
            priceCell.innerHTML = `
                <input type="number" class="product-price empty-placeholder" id="productPrice-${rowIndex}" min="0.001" step="0.001" placeholder="أدخل السعر">
                <div class="price-input-alert" id="priceInputAlert-${rowIndex}" style="display: none;">!</div>
            `;
            
            // إنشاء الخلايا الأخرى - بدون قيم افتراضية
            row.innerHTML = `
                <td>${productCell.innerHTML}</td>
                <td><input type="text" class="product-unit" id="productUnit-${rowIndex}" readonly></td>
                <td><input type="number" class="product-quantity empty-placeholder" id="productQuantity-${rowIndex}" min="0.001" step="0.001" placeholder="أدخل الكمية"></td>
                <td>${priceCell.innerHTML}</td>
                <td class="product-total amount" id="productTotal-${rowIndex}">0.000</td>
                <td class="price-info-container" id="priceInfoContainer-${rowIndex}">
                    <div class="price-info" id="priceInfo-${rowIndex}">لا توجد بيانات سابقة</div>
                    <div class="price-alert" id="priceAlert-${rowIndex}" style="display: none;"></div>
                </td>
                <td><button type="button" class="btn btn-small btn-secondary" onclick="removeInvoiceRow(${rowIndex})">حذف</button></td>
            `;
            
            tbody.appendChild(row);
            
            // إضافة مستمعي الأحداث لحقول الصنف - يظهر من أول حرف
            const productSearch = row.querySelector('.product-search');
            productSearch.addEventListener('input', function() {
                searchProducts(this.value, rowIndex);
            });
            
            // إضافة مستمعي الأحداث لحقول الكمية والسعر
            const quantityInput = row.querySelector('.product-quantity');
            const priceInput = row.querySelector('.product-price');
            
            quantityInput.addEventListener('input', function() {
                updateInvoiceTotal();
                if(productId) {
                    checkPriceChange(rowIndex);
                }
            });
            
            // مستمع خاص للسعر - تنبيه فوري عند الكتابة
            priceInput.addEventListener('input', function() {
                updateInvoiceTotal();
                if(productId) {
                    // تنبيه فوري عند الكتابة
                    immediatePriceAlert(rowIndex);
                }
            });
            
            // مستمع عند ترك حقل السعر (blur)
            priceInput.addEventListener('blur', function() {
                if(productId) {
                    checkPriceChange(rowIndex);
                }
            });
            
            // إذا تم تمرير معرف منتج، تعبئة البيانات تلقائياً
            if(productId) {
                const product = appData.products.find(p => p.id == productId);
                if(product) {
                    const supplier = appData.suppliers.find(s => s.id == product.supplierId);
                    productSearch.value = product.name;
                    row.querySelector('.product-id').value = product.id;
                    row.querySelector('.product-unit').value = product.unit;
                    
                    // البحث عن تاريخ الشراء الأخير لنفس المنتج
                    const previousPurchases = getPreviousPurchases(product.id);
                    if(previousPurchases.length > 0) {
                        const lastPurchase = previousPurchases[0];
                        // لا نضع قيمة افتراضية للسعر - نتركه فارغاً
                        
                        // عرض معلومات الأسعار السابقة
                        displayPriceInfo(previousPurchases, rowIndex);
                    }
                    
                    updateRowTotal(rowIndex);
                }
            }
            
            updateInvoiceTotal();
            
            // إضافة مستمع البحث للمنتجات
            setupProductSearch(rowIndex);
        }
        
        // إعداد البحث عن المنتجات - يظهر من أول حرف
        function setupProductSearch(rowIndex) {
            const searchInput = document.querySelector(`#invoiceRow-${rowIndex} .product-search`);
            const suggestionsDiv = document.querySelector(`#productSuggestions-${rowIndex}`);
            
            searchInput.addEventListener('input', function() {
                const query = this.value;
                
                if(query.trim().length === 0) {
                    suggestionsDiv.classList.remove('active');
                    return;
                }
                
                const filteredProducts = appData.products.filter(product =>
                    product.name.toLowerCase().includes(query.toLowerCase())
                );
                
                if(filteredProducts.length === 0) {
                    suggestionsDiv.innerHTML = '<div class="suggestion-item">لا توجد نتائج</div>';
                } else {
                    suggestionsDiv.innerHTML = filteredProducts.map(product => {
                        const supplier = appData.suppliers.find(s => s.id === product.supplierId);
                        return `<div class="suggestion-item" data-id="${product.id}" data-name="${product.name}" data-unit="${product.unit}">
                            ${product.name} - ${supplier ? supplier.name : 'غير معروف'} (${product.unit})
                        </div>`;
                    }).join('');
                    
                    // إضافة مستمعي الأحداث لعناصر الاقتراحات
                    suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const productId = this.getAttribute('data-id');
                            const productName = this.getAttribute('data-name');
                            const productUnit = this.getAttribute('data-unit');
                            
                            searchInput.value = productName;
                            document.getElementById(`productId-${rowIndex}`).value = productId;
                            document.getElementById(`productUnit-${rowIndex}`).value = productUnit;
                            
                            suggestionsDiv.classList.remove('active');
                            
                            // البحث عن تاريخ الشراء الأخير لنفس المنتج
                            const previousPurchases = getPreviousPurchases(productId);
                            if(previousPurchases.length > 0) {
                                const lastPurchase = previousPurchases[0];
                                // لا نضع قيمة افتراضية للسعر - نتركه فارغاً
                                
                                // عرض معلومات الأسعار السابقة
                                displayPriceInfo(previousPurchases, rowIndex);
                            }
                            
                            updateRowTotal(rowIndex);
                            updateInvoiceTotal();
                        });
                    });
                }
                
                suggestionsDiv.classList.add('active');
            });
            
            // إخفاء قائمة الاقتراحات عند النقر خارجها
            document.addEventListener('click', function(e) {
                if(!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.classList.remove('active');
                }
            });
        }
        
        // البحث عن المنتجات - يظهر من أول حرف
        function searchProducts(query, rowIndex) {
            const suggestionsDiv = document.getElementById(`productSuggestions-${rowIndex}`);
            
            if(query.trim().length === 0) {
                suggestionsDiv.classList.remove('active');
                return;
            }
            
            const filteredProducts = appData.products.filter(product =>
                product.name.toLowerCase().includes(query.toLowerCase())
            );
            
            if(filteredProducts.length === 0) {
                suggestionsDiv.innerHTML = '<div class="suggestion-item">لا توجد نتائج</div>';
            } else {
                suggestionsDiv.innerHTML = filteredProducts.map(product => {
                    const supplier = appData.suppliers.find(s => s.id === product.supplierId);
                    return `<div class="suggestion-item" data-id="${product.id}" data-name="${product.name}" data-unit="${product.unit}">
                        ${product.name} - ${supplier ? supplier.name : 'غير معروف'} (${product.unit})
                    </div>`;
                }).join('');
            }
            
            suggestionsDiv.classList.add('active');
        }
        
        // الحصول على المشتريات السابقة لمنتج معين
        function getPreviousPurchases(productId) {
            const purchases = [];
            
            appData.invoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    if(item.productId == productId) {
                        purchases.push({
                            date: invoice.date,
                            price: item.price,
                            quantity: item.quantity,
                            invoiceNumber: invoice.invoiceNumber
                        });
                    }
                });
            });
            
            // ترتيب حسب التاريخ (الأحدث أولاً)
            purchases.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            return purchases;
        }
        
        // عرض معلومات الأسعار السابقة
        function displayPriceInfo(purchases, rowIndex) {
            const priceInfoDiv = document.getElementById(`priceInfo-${rowIndex}`);
            
            if(purchases.length === 0) {
                priceInfoDiv.innerHTML = "لا توجد بيانات سابقة";
                return;
            }
            
            const lastPurchase = purchases[0];
            
            // إيجاد أعلى وأقل سعر
            let highestPrice = purchases[0].price;
            let lowestPrice = purchases[0].price;
            let highestDate = purchases[0].date;
            let lowestDate = purchases[0].date;
            
            purchases.forEach(purchase => {
                if(purchase.price > highestPrice) {
                    highestPrice = purchase.price;
                    highestDate = purchase.date;
                }
                if(purchase.price < lowestPrice) {
                    lowestPrice = purchase.price;
                    lowestDate = purchase.date;
                }
            });
            
            priceInfoDiv.innerHTML = `
                <span class="last-price">آخر سعر: ${lastPurchase.price.toFixed(3)} (${formatDate(lastPurchase.date)})</span>
                <span class="high-price">أعلى سعر: ${highestPrice.toFixed(3)} (${formatDate(highestDate)})</span>
                <span class="low-price">أقل سعر: ${lowestPrice.toFixed(3)} (${formatDate(lowestDate)})</span>
            `;
        }
        
        // تنبيه فوري عند كتابة السعر - يظهر أثناء الكتابة
        function immediatePriceAlert(rowIndex) {
            const productId = document.getElementById(`productId-${rowIndex}`)?.value;
            const currentPrice = parseFloat(document.getElementById(`productPrice-${rowIndex}`).value);
            const priceInput = document.getElementById(`productPrice-${rowIndex}`);
            const priceAlertDiv = document.getElementById(`priceAlert-${rowIndex}`);
            const priceInputAlert = document.getElementById(`priceInputAlert-${rowIndex}`);
            
            if(!productId || isNaN(currentPrice) || currentPrice <= 0) {
                // إخفاء التنبيهات إذا كان السعر غير صالح
                priceInput.classList.remove('high-price-input');
                priceInputAlert.style.display = 'none';
                priceAlertDiv.style.display = 'none';
                return;
            }
            
            const previousPurchases = getPreviousPurchases(productId);
            if(previousPurchases.length === 0) {
                // لا توجد بيانات سابقة
                priceInput.classList.remove('high-price-input');
                priceInputAlert.style.display = 'none';
                priceAlertDiv.style.display = 'none';
                return;
            }
            
            const lastPurchase = previousPurchases[0];
            const lastPrice = lastPurchase.price;
            const priceDifference = currentPrice - lastPrice;
            const priceChangePercent = (priceDifference / lastPrice) * 100;
            
            // إخفاء التنبيهات إذا كان السعر قريباً من السعر السابق
            if(Math.abs(priceDifference) < 0.001) {
                priceInput.classList.remove('high-price-input');
                priceInputAlert.style.display = 'none';
                priceAlertDiv.style.display = 'none';
                return;
            }
            
            // التحقق من الزيادة الكبيرة في السعر (أكثر من 10%)
            if(priceChangePercent > 10) {
                // تنبيه فوري على حقل الإدخال
                priceInput.classList.add('high-price-input');
                priceInputAlert.style.display = 'flex';
                
                // إعداد رسالة التنبيه الفوري
                let alertMessage = `سعر مرتفع! أعلى من آخر سعر بنسبة ${priceChangePercent.toFixed(1)}%`;
                
                // عرض التنبيه الفوري
                priceAlertDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    ${alertMessage}
                `;
                priceAlertDiv.className = 'price-alert immediate-high-alert';
                priceAlertDiv.style.display = 'flex';
                
            } else if(priceChangePercent > 5) {
                // زيادة متوسطة (بين 5% و 10%)
                priceInput.classList.add('high-price-input');
                priceInputAlert.style.display = 'flex';
                
                let alertMessage = `زيادة في السعر: +${priceChangePercent.toFixed(1)}%`;
                
                priceAlertDiv.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i>
                    ${alertMessage}
                `;
                priceAlertDiv.className = 'price-alert high-price-alert';
                priceAlertDiv.style.display = 'flex';
                
            } else if(priceChangePercent < -10) {
                // انخفاض كبير (أكثر من 10% انخفاض)
                priceInput.classList.remove('high-price-input');
                priceInputAlert.style.display = 'none';
                
                let alertMessage = `انخفاض كبير في السعر: ${priceChangePercent.toFixed(1)}%`;
                
                priceAlertDiv.innerHTML = `
                    <i class="fas fa-arrow-down"></i>
                    ${alertMessage}
                `;
                priceAlertDiv.className = 'price-alert low-price-alert';
                priceAlertDiv.style.display = 'flex';
                
            } else {
                // تغيير بسيط (أقل من 5%)
                priceInput.classList.remove('high-price-input');
                priceInputAlert.style.display = 'none';
                priceAlertDiv.style.display = 'none';
            }
            
            // تحديث مؤشر السعر في عرض معلومات الأسعار
            updatePriceIndicator(rowIndex, priceChangePercent);
        }
        
        // تحديث مؤشر السعر
        function updatePriceIndicator(rowIndex, priceChangePercent) {
            const priceIndicator = document.querySelector(`#priceInfo-${rowIndex} .price-indicator`);
            if(priceIndicator) {
                priceIndicator.remove();
            }
            
            if(Math.abs(priceChangePercent) < 0.1) {
                return; // لا داعي لعرض مؤشر للتغير البسيط
            }
            
            const indicatorSpan = document.createElement('span');
            indicatorSpan.className = `price-indicator ${priceChangePercent > 0 ? 'price-increase' : 'price-decrease'}`;
            indicatorSpan.textContent = priceChangePercent > 0 ? `+${priceChangePercent.toFixed(1)}%` : `${priceChangePercent.toFixed(1)}%`;
            
            const lastPriceSpan = document.querySelector(`#priceInfo-${rowIndex} .last-price`);
            if(lastPriceSpan) {
                lastPriceSpan.appendChild(indicatorSpan);
            }
        }
        
        // التحقق من تغير السعر بعد الانتهاء من الكتابة
        function checkPriceChange(rowIndex) {
            const productId = document.getElementById(`productId-${rowIndex}`)?.value;
            const currentPrice = parseFloat(document.getElementById(`productPrice-${rowIndex}`).value);
            const priceAlertDiv = document.getElementById(`priceAlert-${rowIndex}`);
            const priceInput = document.getElementById(`productPrice-${rowIndex}`);
            const priceInputAlert = document.getElementById(`priceInputAlert-${rowIndex}`);
            
            if(!productId || isNaN(currentPrice) || currentPrice <= 0) {
                priceInput.classList.remove('high-price-input');
                priceInputAlert.style.display = 'none';
                priceAlertDiv.style.display = 'none';
                return;
            }
            
            const previousPurchases = getPreviousPurchases(productId);
            if(previousPurchases.length === 0) {
                priceInput.classList.remove('high-price-input');
                priceInputAlert.style.display = 'none';
                priceAlertDiv.style.display = 'none';
                return;
            }
            
            const lastPurchase = previousPurchases[0];
            const lastPrice = lastPurchase.price;
            const priceDifference = currentPrice - lastPrice;
            const priceChangePercent = (priceDifference / lastPrice) * 100;
            
            // إخفاء التنبيه إذا كان السعر نفسه
            if(Math.abs(priceDifference) < 0.001) {
                priceInput.classList.remove('high-price-input');
                priceInputAlert.style.display = 'none';
                priceAlertDiv.style.display = 'none';
                return;
            }
            
            // التحقق من الزيادة الكبيرة في السعر (أكثر من 10%)
            if(priceChangePercent > 10) {
                // تنبيه نهائي
                let alertMessage = `تنبيه! سعر الشراء الحالي أعلى من آخر سعر شراء بنسبة ${Math.abs(priceChangePercent).toFixed(1)}%`;
                
                priceAlertDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    ${alertMessage}
                `;
                priceAlertDiv.className = 'price-alert immediate-high-alert';
                priceAlertDiv.style.display = 'flex';
                
            } else if(priceChangePercent > 5) {
                // زيادة متوسطة
                let alertMessage = `سعر الشراء الحالي أعلى من آخر سعر شراء بنسبة ${Math.abs(priceChangePercent).toFixed(1)}%`;
                
                priceAlertDiv.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i>
                    ${alertMessage}
                `;
                priceAlertDiv.className = 'price-alert high-price-alert';
                priceAlertDiv.style.display = 'flex';
                
            } else if(priceChangePercent < -10) {
                // انخفاض كبير
                let alertMessage = `سعر الشراء الحالي أقل من آخر سعر شراء بنسبة ${Math.abs(priceChangePercent).toFixed(1)}%`;
                
                priceAlertDiv.innerHTML = `
                    <i class="fas fa-arrow-down"></i>
                    ${alertMessage}
                `;
                priceAlertDiv.className = 'price-alert low-price-alert';
                priceAlertDiv.style.display = 'flex';
                
            } else {
                // تغيير بسيط
                priceAlertDiv.style.display = 'none';
            }
            
            // تحديث مؤشر السعر في عرض معلومات الأسعار
            updatePriceIndicator(rowIndex, priceChangePercent);
        }
        
        // تحديث المجموع للصف
        function updateRowTotal(rowIndex) {
            const quantity = parseFloat(document.getElementById(`productQuantity-${rowIndex}`).value) || 0;
            const price = parseFloat(document.getElementById(`productPrice-${rowIndex}`).value) || 0;
            const total = quantity * price;
            
            document.getElementById(`productTotal-${rowIndex}`).textContent = total.toFixed(3);
        }
        
        // تحديث المجموع الكلي للفاتورة
        function updateInvoiceTotal() {
            let total = 0;
            const rows = document.querySelectorAll('#invoiceItemsBody tr');
            
            rows.forEach(row => {
                const rowId = row.id.split('-')[1];
                const quantity = parseFloat(document.getElementById(`productQuantity-${rowId}`)?.value) || 0;
                const price = parseFloat(document.getElementById(`productPrice-${rowId}`)?.value) || 0;
                total += quantity * price;
                
                // تحديث مجموع الصف
                document.getElementById(`productTotal-${rowId}`).textContent = (quantity * price).toFixed(3);
            });
            
            document.getElementById('invoiceTotal').textContent = total.toFixed(3);
        }
        
        // حذف صف من الفاتورة
        function removeInvoiceRow(rowIndex) {
            const row = document.getElementById(`invoiceRow-${rowIndex}`);
            if(row) {
                row.remove();
                updateInvoiceTotal();
            }
        }
        
        // حفظ الفاتورة
        function saveInvoice() {
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const invoiceDate = document.getElementById('invoiceDate').value;
            const supplierName = document.getElementById('supplierSearch').value.trim();
            
            if(!invoiceNumber) {
                alert("الرجاء إدخال رقم الفاتورة");
                return;
            }
            
            // البحث عن المورد
            const supplier = appData.suppliers.find(s => s.name === supplierName);
            if(!supplier) {
                alert("الرجاء اختيار مورد صحيح من القائمة");
                return;
            }
            
            // جمع عناصر الفاتورة
            const invoiceItems = [];
            let invoiceTotal = 0;
            const rows = document.querySelectorAll('#invoiceItemsBody tr');
            let hasHighPriceAlerts = false;
            let hasMediumPriceAlerts = false;
            let highPriceAlertMessage = "";
            let mediumPriceAlertMessage = "";
            
            rows.forEach(row => {
                const rowId = row.id.split('-')[1];
                const productId = document.getElementById(`productId-${rowId}`)?.value;
                const productName = row.querySelector('.product-search')?.value.trim();
                const unit = document.getElementById(`productUnit-${rowId}`)?.value;
                const quantity = parseFloat(document.getElementById(`productQuantity-${rowId}`)?.value) || 0;
                const price = parseFloat(document.getElementById(`productPrice-${rowId}`)?.value) || 0;
                const total = quantity * price;
                
                if(productId && productName && quantity > 0 && price > 0) {
                    // التحقق من تغير السعر قبل الحفظ
                    const previousPurchases = getPreviousPurchases(productId);
                    if(previousPurchases.length > 0) {
                        const lastPurchase = previousPurchases[0];
                        const lastPrice = lastPurchase.price;
                        const priceDifference = price - lastPrice;
                        const priceChangePercent = (priceDifference / lastPrice) * 100;
                        
                        if(priceChangePercent > 10) {
                            hasHighPriceAlerts = true;
                            highPriceAlertMessage += `- ${productName}: زيادة كبيرة بنسبة ${priceChangePercent.toFixed(1)}% (من ${lastPrice.toFixed(3)} إلى ${price.toFixed(3)})\n`;
                        } else if(priceChangePercent > 5) {
                            hasMediumPriceAlerts = true;
                            mediumPriceAlertMessage += `- ${productName}: زيادة متوسطة بنسبة ${priceChangePercent.toFixed(1)}%\n`;
                        }
                    }
                    
                    invoiceItems.push({
                        productId: parseInt(productId),
                        productName,
                        unit,
                        quantity,
                        price,
                        total
                    });
                    
                    invoiceTotal += total;
                }
            });
            
            if(invoiceItems.length === 0) {
                alert("الرجاء إضافة أصناف إلى الفاتورة");
                return;
            }
            
            // التحقق من وجود تنبيهات أسعار عالية
            if(hasHighPriceAlerts) {
                const confirmMessage = `تحذير! تم تسجيل أسعار مرتفعة بشكل كبير:\n\n${highPriceAlertMessage}\nهل أنت متأكد من حفظ الفاتورة بهذه الأسعار؟`;
                
                if(!confirm(confirmMessage)) {
                    return; // إلغاء حفظ الفاتورة
                }
            }
            
            // التحقق من وجود تنبيهات أسعار متوسطة
            if(hasMediumPriceAlerts && !hasHighPriceAlerts) {
                const confirmMessage = `تنبيه: تم تسجيل زيادات متوسطة في الأسعار:\n\n${mediumPriceAlertMessage}\nهل تريد الاستمرار في حفظ الفاتورة؟`;
                
                if(!confirm(confirmMessage)) {
                    return; // إلغاء حفظ الفاتورة
                }
            }
            
            // إنشاء كائن الفاتورة
            const invoice = {
                id: appData.nextInvoiceId++,
                invoiceNumber,
                date: invoiceDate,
                supplierId: supplier.id,
                items: invoiceItems,
                total: invoiceTotal
            };
            
            // إضافة الفاتورة إلى البيانات
            appData.invoices.push(invoice);
            
            // حفظ البيانات
            saveData();
            
            // إعادة تعيين الفاتورة
            resetInvoiceForm();
            
            // عرض رسالة نجاح
            let successMessage = `تم حفظ الفاتورة ${invoiceNumber} بنجاح!`;
            if(hasHighPriceAlerts) {
                successMessage += "\n\nملاحظة: تم تسجيل الفاتورة رغم وجود أسعار مرتفعة بشكل كبير.";
            } else if(hasMediumPriceAlerts) {
                successMessage += "\n\nملاحظة: تم تسجيل الفاتورة رغم وجود زيادات متوسطة في الأسعار.";
            }
            
            alert(successMessage);
            
            // العودة إلى لوحة التحكم
            showPage('dashboard');
        }
        
        // إعادة تعيين نموذج الفاتورة
        function resetInvoiceForm() {
            document.getElementById('purchaseForm').reset();
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('supplierSearch').value = "";
            document.getElementById('supplierSuggestions').classList.remove('active');
            
            // إعادة تعيين جدول العناصر
            document.getElementById('invoiceItemsBody').innerHTML = "";
            document.getElementById('invoiceTotal').textContent = "0.000";
            
            // إضافة 5 أسطر فارغة
            for(let i = 0; i < 5; i++) {
                addInvoiceRow();
            }
        }
        
        // تحديث القائمة المنسدلة للموردين
        function updateSupplierDropdown() {
            const dropdown = document.getElementById('productSupplier');
            dropdown.innerHTML = '<option value="">اختر المورد</option>';
            
            appData.suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name;
                dropdown.appendChild(option);
            });
        }
        
        // حفظ المورد
        function saveSupplier() {
            const name = document.getElementById('supplierName').value.trim();
            const phone = document.getElementById('supplierPhone').value.trim();
            const email = document.getElementById('supplierEmail').value.trim();
            const address = document.getElementById('supplierAddress').value.trim();
            
            if(!name) {
                alert("الرجاء إدخال اسم المورد");
                return;
            }
            
            if(appData.editingSupplierId) {
                // تحديث المورد الحالي
                const supplierIndex = appData.suppliers.findIndex(s => s.id === appData.editingSupplierId);
                if(supplierIndex !== -1) {
                    appData.suppliers[supplierIndex] = {
                        id: appData.editingSupplierId,
                        name,
                        phone,
                        email,
                        address
                    };
                }
                appData.editingSupplierId = null;
            } else {
                // إضافة مورد جديد
                const newSupplier = {
                    id: appData.nextSupplierId++,
                    name,
                    phone,
                    email,
                    address
                };
                appData.suppliers.push(newSupplier);
            }
            
            // حفظ البيانات
            saveData();
            
            // إعادة تعيين النموذج
            resetSupplierForm();
            
            // تحديث القوائم
            updateSupplierDropdown();
            populateSuppliersList();
            
            alert("تم حفظ المورد بنجاح!");
        }
        
        // إعادة تعيين نموذج المورد
        function resetSupplierForm() {
            document.getElementById('supplierForm').reset();
            appData.editingSupplierId = null;
            document.querySelector('#supplierForm button[type="submit"]').textContent = "حفظ المورد";
        }
        
        // تعبئة قائمة الموردين
        function populateSuppliersList() {
            const tbody = document.getElementById('suppliersList');
            tbody.innerHTML = "";
            
            appData.suppliers.forEach(supplier => {
                // حساب عدد الأصناف لهذا المورد
                const productCount = appData.products.filter(p => p.supplierId === supplier.id).length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${supplier.id}</td>
                    <td>${supplier.name}</td>
                    <td>${supplier.phone || '-'}</td>
                    <td>${supplier.email || '-'}</td>
                    <td>${supplier.address || '-'}</td>
                    <td>${productCount}</td>
                    <td>
                        <button class="btn btn-small" onclick="editSupplier(${supplier.id})">تعديل</button>
                        <button class="btn btn-small btn-secondary" onclick="deleteSupplier(${supplier.id})">حذف</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // تعديل مورد
        function editSupplier(supplierId) {
            const supplier = appData.suppliers.find(s => s.id === supplierId);
            if(!supplier) return;
            
            document.getElementById('supplierName').value = supplier.name;
            document.getElementById('supplierPhone').value = supplier.phone || '';
            document.getElementById('supplierEmail').value = supplier.email || '';
            document.getElementById('supplierAddress').value = supplier.address || '';
            
            appData.editingSupplierId = supplierId;
            document.querySelector('#supplierForm button[type="submit"]').textContent = "تحديث المورد";
            
            // الانتقال إلى قسم الموردين
            showPage('suppliers');
        }
        
        // حذف مورد
        function deleteSupplier(supplierId) {
            if(confirm("هل أنت متأكد من حذف هذا المورد؟")) {
                // التحقق مما إذا كان هناك أصناف مرتبطة بهذا المورد
                const relatedProducts = appData.products.filter(p => p.supplierId === supplierId);
                if(relatedProducts.length > 0) {
                    if(!confirm("هذا المورد لديه أصناف مرتبطة به. سيتم حذف جميع الأصناف المرتبطة. هل تريد الاستمرار؟")) {
                        return;
                    }
                    
                    // حذف الأصناف المرتبطة
                    appData.products = appData.products.filter(p => p.supplierId !== supplierId);
                }
                
                // حذف المورد
                appData.suppliers = appData.suppliers.filter(s => s.id !== supplierId);
                
                // حفظ البيانات
                saveData();
                
                // تحديث القوائم
                updateSupplierDropdown();
                populateSuppliersList();
                populateProductsList();
                
                alert("تم حذف المورد بنجاح!");
            }
        }
        
        // حفظ الصنف
        function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const supplierId = parseInt(document.getElementById('productSupplier').value);
            const unit = document.getElementById('productUnit').value;
            const category = document.getElementById('productCategory').value.trim();
            
            if(!name || !supplierId || !unit) {
                alert("الرجاء إدخال جميع الحقول المطلوبة");
                return;
            }
            
            if(appData.editingProductId) {
                // تحديث الصنف الحالي
                const productIndex = appData.products.findIndex(p => p.id === appData.editingProductId);
                if(productIndex !== -1) {
                    appData.products[productIndex] = {
                        id: appData.editingProductId,
                        name,
                        supplierId,
                        unit,
                        category
                    };
                }
                appData.editingProductId = null;
            } else {
                // إضافة صنف جديد
                const newProduct = {
                    id: appData.nextProductId++,
                    name,
                    supplierId,
                    unit,
                    category
                };
                appData.products.push(newProduct);
            }
            
            // حفظ البيانات
            saveData();
            
            // إعادة تعيين النموذج
            resetProductForm();
            
            // تحديث القوائم
            populateProductsList();
            
            alert("تم حفظ الصنف بنجاح!");
        }
        
        // إعادة تعيين نموذج الصنف
        function resetProductForm() {
            document.getElementById('productForm').reset();
            appData.editingProductId = null;
            document.querySelector('#productForm button[type="submit"]').textContent = "حفظ الصنف";
        }
        
        // تعبئة قائمة الأصناف
        function populateProductsList() {
            const tbody = document.getElementById('productsList');
            tbody.innerHTML = "";
            
            appData.products.forEach(product => {
                const supplier = appData.suppliers.find(s => s.id === product.supplierId);
                const supplierName = supplier ? supplier.name : 'غير معروف';
                
                // البحث عن آخر عملية شراء لهذا المنتج
                const lastPurchase = getLastPurchaseForProduct(product.id);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.id}</td>
                    <td>${product.name}</td>
                    <td>${supplierName}</td>
                    <td>${product.unit}</td>
                    <td>${product.category || '-'}</td>
                    <td>${lastPurchase ? formatDate(lastPurchase.date) : 'لا توجد مشتريات'}</td>
                    <td class="amount">${lastPurchase ? lastPurchase.price.toFixed(3) : '0.000'}</td>
                    <td>
                        <button class="btn btn-small" onclick="editProduct(${product.id})">تعديل</button>
                        <button class="btn btn-small btn-secondary" onclick="deleteProduct(${product.id})">حذف</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // الحصول على آخر عملية شراء لمنتج معين
        function getLastPurchaseForProduct(productId) {
            for(let i = appData.invoices.length - 1; i >= 0; i--) {
                const invoice = appData.invoices[i];
                for(let j = 0; j < invoice.items.length; j++) {
                    const item = invoice.items[j];
                    if(item.productId == productId) {
                        return {
                            date: invoice.date,
                            price: item.price
                        };
                    }
                }
            }
            return null;
        }
        
        // تعديل صنف
        function editProduct(productId) {
            const product = appData.products.find(p => p.id === productId);
            if(!product) return;
            
            document.getElementById('productName').value = product.name;
            document.getElementById('productSupplier').value = product.supplierId;
            document.getElementById('productUnit').value = product.unit;
            document.getElementById('productCategory').value = product.category || '';
            
            appData.editingProductId = productId;
            document.querySelector('#productForm button[type="submit"]').textContent = "تحديث الصنف";
            
            // الانتقال إلى قسم الأصناف
            showPage('products');
        }
        
        // حذف صنف
        function deleteProduct(productId) {
            if(confirm("هل أنت متأكد من حذف هذا الصنف؟")) {
                appData.products = appData.products.filter(p => p.id !== productId);
                
                // حفظ البيانات
                saveData();
                
                // تحديث القوائم
                populateProductsList();
                
                alert("تم حذف الصنف بنجاح!");
            }
        }
        
        // تحديث الإحصائيات
        function updateStatistics() {
            // تحديث العدادات
            document.getElementById('suppliersCount').textContent = appData.suppliers.length;
            document.getElementById('productsCount').textContent = appData.products.length;
            document.getElementById('invoicesCount').textContent = appData.invoices.length;
            
            // حساب متوسط تغير السعر
            let priceChanges = [];
            appData.products.forEach(product => {
                const purchases = getPreviousPurchases(product.id);
                if(purchases.length > 1) {
                    const firstPrice = purchases[purchases.length - 1].price;
                    const lastPrice = purchases[0].price;
                    const change = ((lastPrice - firstPrice) / firstPrice) * 100;
                    priceChanges.push(change);
                }
            });
            
            const avgChange = priceChanges.length > 0 
                ? (priceChanges.reduce((a, b) => a + b, 0) / priceChanges.length).toFixed(1)
                : 0;
            
            document.getElementById('avgPriceChange').textContent = `${avgChange}%`;
            
            // تحديث الكروت المتحركة
            document.getElementById('floatingActiveSuppliers').textContent = appData.suppliers.length;
            document.getElementById('floatingHighestIncrease').textContent = `${avgChange}%`;
            document.getElementById('floatingLastUpdate').textContent = new Date().toLocaleTimeString('ar-SA', {hour: '2-digit', minute:'2-digit'});
        }
        
        // تحديث المشتريات الحديثة
        function updateRecentPurchases() {
            const tbody = document.getElementById('recentPurchasesBody');
            tbody.innerHTML = "";
            
            // أخذ آخر 5 فواتير
            const recentInvoices = [...appData.invoices]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            recentInvoices.forEach(invoice => {
                const supplier = appData.suppliers.find(s => s.id === invoice.supplierId);
                const supplierName = supplier ? supplier.name : 'غير معروف';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${invoice.invoiceNumber}</td>
                    <td>${supplierName}</td>
                    <td>${formatDate(invoice.date)}</td>
                    <td>${invoice.items.length}</td>
                    <td class="amount">${invoice.total.toFixed(3)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // تغيير نوع التقرير
        function changeReportType() {
            updateReportFilters();
        }
        
        // تحديث عوامل التصفية للتقرير
        function updateReportFilters() {
            const reportType = document.getElementById('reportType').value;
            const filterSelect = document.getElementById('reportFilter');
            
            filterSelect.innerHTML = '<option value="all">الكل</option>';
            
            if(reportType === 'productsReport') {
                appData.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    filterSelect.appendChild(option);
                });
            } else if(reportType === 'suppliersReport') {
                appData.suppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.id;
                    option.textContent = supplier.name;
                    filterSelect.appendChild(option);
                });
            }
        }
        
        // إنشاء التقرير
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const filterValue = document.getElementById('reportFilter').value;
            const dateFrom = document.getElementById('reportDate').value;
            const dateTo = document.getElementById('reportDateTo').value;
            
            const reportContainer = document.getElementById('reportContent');
            reportContainer.innerHTML = "";
            
            if(reportType === 'productsReport') {
                document.getElementById('reportTitle').textContent = "تقرير الأصناف - 2025";
                
                // جمع جميع عمليات الشراء للمنتجات
                let allPurchases = [];
                appData.invoices.forEach(invoice => {
                    invoice.items.forEach(item => {
                        const product = appData.products.find(p => p.id == item.productId);
                        const supplier = appData.suppliers.find(s => s.id == invoice.supplierId);
                        
                        if(product) {
                            allPurchases.push({
                                productName: product.name,
                                supplierName: supplier ? supplier.name : 'غير معروف',
                                date: invoice.date,
                                price: item.price,
                                quantity: item.quantity,
                                unit: item.unit,
                                invoiceNumber: invoice.invoiceNumber,
                                productId: product.id
                            });
                        }
                    });
                });
                
                // تصفية حسب المنتج إذا تم اختياره
                if(filterValue !== 'all') {
                    allPurchases = allPurchases.filter(p => p.productId == filterValue);
                }
                
                // تصفية حسب التاريخ
                if(dateFrom) {
                    allPurchases = allPurchases.filter(p => p.date >= dateFrom);
                }
                if(dateTo) {
                    allPurchases = allPurchases.filter(p => p.date <= dateTo);
                }
                
                // ترتيب حسب التاريخ (الأحدث أولاً)
                allPurchases.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // إنشاء جدول التقرير
                let tableHTML = `
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>الصنف</th>
                                <th>المورد</th>
                                <th>تاريخ الشراء</th>
                                <th>سعر الشراء</th>
                                <th>الكمية</th>
                                <th>الوحدة</th>
                                <th>رقم الفاتورة</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                allPurchases.forEach(purchase => {
                    tableHTML += `
                        <tr>
                            <td>${purchase.productName}</td>
                            <td>${purchase.supplierName}</td>
                            <td>${formatDate(purchase.date)}</td>
                            <td class="amount">${purchase.price.toFixed(3)}</td>
                            <td>${purchase.quantity}</td>
                            <td>${purchase.unit}</td>
                            <td>${purchase.invoiceNumber}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                reportContainer.innerHTML = tableHTML;
                
            } else if(reportType === 'suppliersReport') {
                document.getElementById('reportTitle').textContent = "تقرير الموردين - 2025";
                
                // جمع جميع عمليات الشراء للموردين
                let allPurchases = [];
                appData.invoices.forEach(invoice => {
                    const supplier = appData.suppliers.find(s => s.id == invoice.supplierId);
                    
                    invoice.items.forEach(item => {
                        const product = appData.products.find(p => p.id == item.productId);
                        
                        if(supplier) {
                            allPurchases.push({
                                supplierName: supplier.name,
                                productName: product ? product.name : 'غير معروف',
                                date: invoice.date,
                                price: item.price,
                                quantity: item.quantity,
                                unit: item.unit,
                                total: item.total,
                                supplierId: supplier.id
                            });
                        }
                    });
                });
                
                // تصفية حسب المورد إذا تم اختياره
                if(filterValue !== 'all') {
                    allPurchases = allPurchases.filter(p => p.supplierId == filterValue);
                }
                
                // تصفية حسب التاريخ
                if(dateFrom) {
                    allPurchases = allPurchases.filter(p => p.date >= dateFrom);
                }
                if(dateTo) {
                    allPurchases = allPurchases.filter(p => p.date <= dateTo);
                }
                
                // ترتيب حسب التاريخ (الأحدث أولاً)
                allPurchases.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // إنشاء جدول التقرير
                let tableHTML = `
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>المورد</th>
                                <th>الصنف</th>
                                <th>تاريخ الشراء</th>
                                <th>سعر الشراء</th>
                                <th>الكمية</th>
                                <th>الوحدة</th>
                                <th>المجموع</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                allPurchases.forEach(purchase => {
                    tableHTML += `
                        <tr>
                            <td>${purchase.supplierName}</td>
                            <td>${purchase.productName}</td>
                            <td>${formatDate(purchase.date)}</td>
                            <td class="amount">${purchase.price.toFixed(3)}</td>
                            <td>${purchase.quantity}</td>
                            <td>${purchase.unit}</td>
                            <td class="amount">${purchase.total.toFixed(3)}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                reportContainer.innerHTML = tableHTML;
                
            } else if(reportType === 'priceChanges') {
                document.getElementById('reportTitle').textContent = "تقرير تغيرات الأسعار - 2025";
                
                // تحليل تغيرات الأسعار لكل منتج
                let analysisHTML = `
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>الصنف</th>
                                <th>المورد</th>
                                <th>آخر سعر</th>
                                <th>أعلى سعر</th>
                                <th>أقل سعر</th>
                                <th>متوسط السعر</th>
                                <th>نسبة التغير</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                appData.products.forEach(product => {
                    const purchases = getPreviousPurchases(product.id);
                    const supplier = appData.suppliers.find(s => s.id == product.supplierId);
                    
                    if(purchases.length > 0) {
                        const lastPrice = purchases[0].price;
                        
                        // إيجاد أعلى وأقل سعر
                        let highestPrice = purchases[0].price;
                        let lowestPrice = purchases[0].price;
                        let totalPrice = 0;
                        
                        purchases.forEach(purchase => {
                            if(purchase.price > highestPrice) highestPrice = purchase.price;
                            if(purchase.price < lowestPrice) lowestPrice = purchase.price;
                            totalPrice += purchase.price;
                        });
                        
                        const avgPrice = totalPrice / purchases.length;
                        const firstPrice = purchases[purchases.length - 1].price;
                        const changePercent = ((lastPrice - firstPrice) / firstPrice) * 100;
                        
                        analysisHTML += `
                            <tr>
                                <td>${product.name}</td>
                                <td>${supplier ? supplier.name : 'غير معروف'}</td>
                                <td class="amount">${lastPrice.toFixed(3)}</td>
                                <td class="amount">${highestPrice.toFixed(3)}</td>
                                <td class="amount">${lowestPrice.toFixed(3)}</td>
                                <td class="amount">${avgPrice.toFixed(3)}</td>
                                <td>${changePercent.toFixed(1)}%</td>
                            </tr>
                        `;
                    }
                });
                
                analysisHTML += `
                        </tbody>
                    </table>
                `;
                
                reportContainer.innerHTML = analysisHTML;
                
            } else if(reportType === 'purchaseHistory') {
                document.getElementById('reportTitle').textContent = "سجل المشتريات - 2025";
                
                // نسخة من الفواتير للترتيب
                let invoices = [...appData.invoices];
                
                // تصفية حسب التاريخ
                if(dateFrom) {
                    invoices = invoices.filter(inv => inv.date >= dateFrom);
                }
                if(dateTo) {
                    invoices = invoices.filter(inv => inv.date <= dateTo);
                }
                
                // ترتيب حسب التاريخ (الأحدث أولاً)
                invoices.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // إنشاء جدول التقرير
                let tableHTML = `
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>المورد</th>
                                <th>التاريخ</th>
                                <th>عدد الأصناف</th>
                                <th>المجموع</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                invoices.forEach(invoice => {
                    const supplier = appData.suppliers.find(s => s.id == invoice.supplierId);
                    
                    tableHTML += `
                        <tr>
                            <td>${invoice.invoiceNumber}</td>
                            <td>${supplier ? supplier.name : 'غير معروف'}</td>
                            <td>${formatDate(invoice.date)}</td>
                            <td>${invoice.items.length}</td>
                            <td class="amount">${invoice.total.toFixed(3)}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                reportContainer.innerHTML = tableHTML;
                
            } else if(reportType === 'invoiceDetails') {
                document.getElementById('reportTitle').textContent = "تفاصيل الفواتير - 2025";
                
                // نسخة من الفواتير للترتيب
                let invoices = [...appData.invoices];
                
                // تصفية حسب التاريخ
                if(dateFrom) {
                    invoices = invoices.filter(inv => inv.date >= dateFrom);
                }
                if(dateTo) {
                    invoices = invoices.filter(inv => inv.date <= dateTo);
                }
                
                // ترتيب حسب التاريخ (الأحدث أولاً)
                invoices.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // عرض كل فاتورة بشكل احترافي
                invoices.forEach(invoice => {
                    const supplier = appData.suppliers.find(s => s.id == invoice.supplierId);
                    
                    let invoiceHTML = `
                        <div class="card" style="margin-bottom: 30px;">
                            <div class="card-header">
                                <h3 class="card-title">فاتورة رقم: ${invoice.invoiceNumber}</h3>
                                <span class="invoice-badge">${formatDate(invoice.date)}</span>
                            </div>
                            <div class="card" style="background-color: #F9F9F9; padding: 15px; margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <div><strong>المورد:</strong> ${supplier ? supplier.name : 'غير معروف'}</div>
                                    <div><strong>التاريخ:</strong> ${formatDate(invoice.date)}</div>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <div><strong>رقم الفاتورة:</strong> ${invoice.invoiceNumber}</div>
                                    <div><strong>عدد الأصناف:</strong> ${invoice.items.length}</div>
                                </div>
                            </div>
                            <table class="invoice-details-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>الصنف</th>
                                        <th>الوحدة</th>
                                        <th>الكمية</th>
                                        <th>سعر الوحدة</th>
                                        <th>المجموع</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    invoice.items.forEach((item, index) => {
                        invoiceHTML += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.productName}</td>
                                <td>${item.unit}</td>
                                <td>${item.quantity}</td>
                                <td class="amount">${item.price.toFixed(3)}</td>
                                <td class="amount">${item.total.toFixed(3)}</td>
                            </tr>
                        `;
                    });
                    
                    invoiceHTML += `
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td colspan="5" style="text-align: left; font-weight: bold;">الإجمالي:</td>
                                        <td class="amount" style="font-weight: bold;">${invoice.total.toFixed(3)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                    
                    reportContainer.innerHTML += invoiceHTML;
                });
            }
        }
        
        // طباعة التقرير
        function printReport() {
            window.print();
        }
        
        // تنسيق التاريخ
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.toLocaleString('ar-SA', { month: 'long' });
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }
    </script>
</body>
</html>